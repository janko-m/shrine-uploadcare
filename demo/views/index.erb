<h1><%= @album.name %></h1>

<form action="/album" method="post">
  <input type="hidden" name="_method" value="put">
  <%= csrf_tag %>
  <ul class="list-unstyled">
    <% @album.photos.each_with_index do |photo, idx| %>
      <%= partial("photo", locals: {photo: photo, idx: idx}) %>
    <% end %>
  </ul>
  <input type="submit" value="Save" class="btn btn-default">
  <a href="#" class="btn btn-primary file-upload">Upload photos</a>
</form>

<script>
  $(".file-upload").on("click", function(e) {
    var dialog = uploadcare.openDialog(null, {
      publicKey: '<%= ENV.fetch("UPLOADCARE_PUBLIC_KEY") %>',
      imagesOnly: true,
      multiple: true,
      multipleMax: 10,
      doNotStore: true,
      imageShrink: '1024x1024',
    });

    dialog.done(function(result) {
      var files = result.files().map(function(filePromise) {
        var file = null;
        filePromise.done(function(info) { file = info; })

        return {
          id: file['uuid'],
          storage: 'cache',
          metadata: {
            size: file['size'],
            filename: file['name'],
            mime_type: file['mimeType'],
            uploadcare: file,
          }
        }
      });

      var data = {
        photos: files.map(function(file) {
          return {image: JSON.stringify(file)}
        }),
        _csrf: $("input[name=_csrf]").val(),
      };

      $.ajax("/album/photos", {method: 'POST', data: data})
        .done(function(data) { $("ul").append(data) });
    });
  });
</script>
